<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Air Pollution Prediction System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .search-section {
        padding: 40px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
      }

      .search-box {
        display: flex;
        gap: 15px;
        max-width: 600px;
        margin: 0 auto;
      }

      .search-input {
        flex: 1;
        padding: 15px 20px;
        font-size: 1.1rem;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        outline: none;
        transition: border-color 0.3s;
      }

      .search-input:focus {
        border-color: #667eea;
      }

      .search-btn {
        padding: 15px 30px;
        font-size: 1.1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        font-weight: 600;
      }

      .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .search-btn:active {
        transform: translateY(0);
      }

      .search-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .content {
        padding: 40px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
        font-size: 1.2rem;
      }

      .loading::after {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #667eea;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #fee;
        color: #c33;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 4px solid #c33;
      }

      .current-aqi {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
      }

      .current-aqi h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
      }

      .aqi-value {
        font-size: 4rem;
        font-weight: bold;
        margin: 20px 0;
      }

      .health-message {
        font-size: 1.5rem;
        font-weight: 600;
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        display: inline-block;
        margin: 10px 0;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .metric-card {
        background: rgba(255, 255, 255, 0.2);
        padding: 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
      }

      .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .metric-value {
        font-size: 1.8rem;
        font-weight: bold;
      }

      .chart-section {
        margin: 40px 0;
        padding: 30px;
        background: #f8f9fa;
        border-radius: 15px;
      }

      .chart-section h2 {
        color: #333;
        margin-bottom: 20px;
      }

      .chart-container {
        position: relative;
        height: 400px;
        background: white;
        padding: 20px;
        border-radius: 10px;
      }

      .prediction-section {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-top: 30px;
      }

      .prediction-section h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
      }

      .prediction-value {
        font-size: 3rem;
        font-weight: bold;
        margin: 20px 0;
      }

      .risk-badge {
        display: inline-block;
        padding: 10px 25px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 10px;
      }

      .aqi-good {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      }

      .aqi-moderate {
        background: linear-gradient(135deg, #fbc531 0%, #f5b041 100%);
      }

      .aqi-unhealthy {
        background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
      }

      .aqi-very-unhealthy {
        background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      }

      .aqi-hazardous {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8rem;
        }

        .search-box {
          flex-direction: column;
        }

        .aqi-value {
          font-size: 3rem;
        }

        .metrics-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üåç Air Pollution Prediction System</h1>
        <p>Get real-time AQI data and predictions for any city</p>
      </div>

      <div class="search-section">
        <div class="search-box">
          <input
            type="text"
            class="search-input"
            id="cityInput"
            placeholder="Enter city name (e.g., Delhi, London, New York)"
            onkeypress="if(event.key === 'Enter') searchCity()"
          />
          <button class="search-btn" onclick="searchCity()" id="searchBtn">
            Get AQI Data
          </button>
        </div>
      </div>

      <div class="content" id="content">
        <div class="loading" id="loading" style="display: none">Loading...</div>
        <div id="error" style="display: none"></div>
        <div id="results" style="display: none"></div>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:8000";
      let chartInstance = null;

      async function searchCity() {
        const cityInput = document.getElementById("cityInput");
        const searchBtn = document.getElementById("searchBtn");
        const loading = document.getElementById("loading");
        const error = document.getElementById("error");
        const results = document.getElementById("results");

        const city = cityInput.value.trim();

        if (!city) {
          showError("Please enter a city name");
          return;
        }

        // Show loading
        loading.style.display = "block";
        error.style.display = "none";
        results.style.display = "none";
        searchBtn.disabled = true;

        try {
          // Fetch current AQI, history, and prediction in parallel
          const [currentData, historyData, predictionData] = await Promise.all([
            fetch(
              `${API_BASE_URL}/current?city=${encodeURIComponent(city)}`
            ).then((r) => r.json()),
            fetch(
              `${API_BASE_URL}/history?city=${encodeURIComponent(city)}`
            ).then((r) => r.json()),
            fetch(
              `${API_BASE_URL}/predict?city=${encodeURIComponent(city)}`
            ).then((r) => r.json()),
          ]);

          // Check for errors
          if (
            currentData.detail ||
            historyData.detail ||
            predictionData.detail
          ) {
            const errorMsg =
              currentData.detail || historyData.detail || predictionData.detail;
            showError(errorMsg);
            return;
          }

          // Display results
          displayResults(currentData, historyData, predictionData);
        } catch (err) {
          console.error("Error:", err);
          showError(
            `Failed to fetch data: ${err.message}. Make sure the backend server is running on ${API_BASE_URL}`
          );
        } finally {
          loading.style.display = "none";
          searchBtn.disabled = false;
        }
      }

      function showError(message) {
        const error = document.getElementById("error");
        error.style.display = "block";
        error.className = "error";
        error.textContent = message;
      }

      function getAQIClass(aqi) {
        if (aqi <= 50) return "aqi-good";
        if (aqi <= 100) return "aqi-moderate";
        if (aqi <= 150) return "aqi-unhealthy";
        if (aqi <= 200) return "aqi-very-unhealthy";
        return "aqi-hazardous";
      }

      function displayResults(current, history, prediction) {
        const results = document.getElementById("results");
        results.style.display = "block";

        // Current AQI Section
        const aqiClass = getAQIClass(current.aqi);
        const currentHTML = `
                <div class="current-aqi ${aqiClass}">
                    <h2>üìç ${current.city}</h2>
                    <div class="aqi-value">${current.aqi}</div>
                    <div class="health-message">${
                      current.health_message || getHealthMessage(current.aqi)
                    }</div>
                    
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">PM2.5</div>
                            <div class="metric-value">${current.pm25}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">PM10</div>
                            <div class="metric-value">${current.pm10}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">O‚ÇÉ</div>
                            <div class="metric-value">${current.o3}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">NO‚ÇÇ</div>
                            <div class="metric-value">${current.no2}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">CO</div>
                            <div class="metric-value">${current.co}</div>
                        </div>
                        ${
                          current.temperature
                            ? `
                        <div class="metric-card">
                            <div class="metric-label">Temperature</div>
                            <div class="metric-value">${current.temperature}¬∞C</div>
                        </div>
                        `
                            : ""
                        }
                        ${
                          current.humidity
                            ? `
                        <div class="metric-card">
                            <div class="metric-label">Humidity</div>
                            <div class="metric-value">${current.humidity}%</div>
                        </div>
                        `
                            : ""
                        }
                        ${
                          current.wind
                            ? `
                        <div class="metric-card">
                            <div class="metric-label">Wind</div>
                            <div class="metric-value">${current.wind} m/s</div>
                        </div>
                        `
                            : ""
                        }
                    </div>
                    ${
                      current.time
                        ? `<div style="margin-top: 20px; opacity: 0.9;">Last updated: ${new Date(
                            current.time
                          ).toLocaleString()}</div>`
                        : ""
                    }
                </div>
            `;

        // History Chart Section
        const historyHTML = `
                <div class="chart-section">
                    <h2>üìä Last 7 Days AQI History</h2>
                    <div class="chart-container">
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>
            `;

        // Prediction Section with confidence and metrics
        const predAqiClass = getAQIClass(prediction.predicted_aqi);
        const confidenceScore = prediction.confidence_score
          ? (prediction.confidence_score * 100).toFixed(1)
          : "N/A";
        const metrics = prediction.model_metrics || {};
        const r2Score = metrics.r2_score
          ? (metrics.r2_score * 100).toFixed(1)
          : "N/A";
        const mae = metrics.mae ? metrics.mae.toFixed(2) : "N/A";

        const predictionHTML = `
                <div class="prediction-section ${predAqiClass}">
                    <h2>üîÆ Predicted AQI for Tomorrow</h2>
                    <div class="prediction-value">${Math.round(
                      prediction.predicted_aqi
                    )}</div>
                    <div class="risk-badge">${
                      prediction.risk || prediction.health_message
                    }</div>
                    ${
                      prediction.confidence_score
                        ? `
                    <div style="margin-top: 20px; display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Confidence</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${confidenceScore}%</div>
                        </div>
                        ${
                          metrics.r2_score
                            ? `
                        <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">R¬≤ Score</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${r2Score}%</div>
                        </div>
                        `
                            : ""
                        }
                        ${
                          metrics.mae
                            ? `
                        <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">MAE</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${mae}</div>
                        </div>
                        `
                            : ""
                        }
                    </div>
                    `
                        : ""
                    }
                </div>
            `;

        results.innerHTML = currentHTML + historyHTML + predictionHTML;

        // Draw chart
        drawChart(history.history || []);
      }

      function drawChart(historyData) {
        const ctx = document.getElementById("historyChart").getContext("2d");

        // Destroy existing chart if it exists
        if (chartInstance) {
          chartInstance.destroy();
        }

        const labels = historyData.map((item) => {
          const date = new Date(item.day);
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        });

        const aqiValues = historyData.map((item) => item.aqi);

        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "AQI",
                data: aqiValues,
                borderColor: "#667eea",
                backgroundColor: "rgba(102, 126, 234, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: "#667eea",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "AQI Value",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Date",
                },
              },
            },
          },
        });
      }

      function getHealthMessage(aqi) {
        if (aqi <= 50) return "Good";
        if (aqi <= 100) return "Moderate";
        if (aqi <= 150) return "Unhealthy for Sensitive Groups";
        if (aqi <= 200) return "Unhealthy";
        if (aqi <= 300) return "Very Unhealthy";
        return "Hazardous";
      }
    </script>
  </body>
</html>
