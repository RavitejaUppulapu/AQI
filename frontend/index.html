<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Air Pollution Prediction System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 0;
        margin: 0;
      }

      .container {
        max-width: 1200px;
        margin: 20px auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .search-section {
        padding: 40px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
      }

      .search-box {
        display: flex;
        gap: 15px;
        max-width: 600px;
        margin: 0 auto;
      }

      .search-input {
        flex: 1;
        padding: 15px 20px;
        font-size: 1.1rem;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        outline: none;
        transition: border-color 0.3s;
      }

      .search-input:focus {
        border-color: #667eea;
      }

      .search-btn {
        padding: 15px 30px;
        font-size: 1.1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        font-weight: 600;
      }

      .search-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .search-btn:active {
        transform: translateY(0);
      }

      .search-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .content {
        padding: 40px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
        font-size: 1.2rem;
      }

      .loading::after {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #667eea;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #fee;
        color: #c33;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 4px solid #c33;
      }

      .current-aqi {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
      }

      .current-aqi h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
      }

      .aqi-value {
        font-size: 4rem;
        font-weight: bold;
        margin: 20px 0;
      }

      .health-message {
        font-size: 1.5rem;
        font-weight: 600;
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        display: inline-block;
        margin: 10px 0;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .metric-card {
        background: rgba(255, 255, 255, 0.2);
        padding: 20px;
        border-radius: 10px;
        backdrop-filter: blur(10px);
      }

      .metric-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .metric-value {
        font-size: 1.6rem;
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .chart-section {
        margin: 40px 0;
        padding: 30px;
        background: #f8f9fa;
        border-radius: 15px;
      }

      .chart-section h2 {
        color: #333;
        margin-bottom: 20px;
      }

      .chart-container {
        position: relative;
        height: 400px;
        background: white;
        padding: 20px;
        border-radius: 10px;
      }

      .prediction-section {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-top: 30px;
      }

      .prediction-section h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
      }

      .prediction-value {
        font-size: 3rem;
        font-weight: bold;
        margin: 20px 0;
      }

      .risk-badge {
        display: inline-block;
        padding: 10px 25px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 10px;
      }

      .aqi-good {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      }

      .aqi-moderate {
        background: linear-gradient(135deg, #fbc531 0%, #f5b041 100%);
      }

      .aqi-unhealthy {
        background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
      }

      .aqi-very-unhealthy {
        background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      }

      .aqi-hazardous {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      }

      .alerts-section {
        margin-top: 30px;
        padding: 25px 30px;
        background: #f8f9fa;
        border-radius: 15px;
      }

      .alerts-section h2 {
        font-size: 1.4rem;
        margin-bottom: 15px;
        color: #333;
      }

      .alerts-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 12px;
      }

      .alert-card {
        border-radius: 12px;
        padding: 12px 14px;
        font-size: 0.95rem;
        background: #ffffff;
        border-left: 4px solid #4caf50;
      }

      .alert-card.warning {
        border-left-color: #f5b041;
      }

      .alert-card.critical {
        border-left-color: #e74c3c;
      }

      .alert-type {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        opacity: 0.8;
      }

      .alert-message {
        margin-top: 4px;
      }

      .legend-section {
        padding: 25px 30px 35px;
        background: #f8f9fa;
        border-top: 1px solid #e0e0e0;
      }

      .legend-section h2 {
        font-size: 1.4rem;
        margin-bottom: 15px;
        color: #333;
      }

      .legend-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.95rem;
      }

      .legend-color {
        width: 18px;
        height: 18px;
        border-radius: 6px;
      }

      .legend-label {
        font-weight: 600;
      }

      .legend-range {
        font-size: 0.85rem;
        color: #555;
      }

      .feature-section {
        background: white;
        padding: 25px 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .feature-section h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
        color: #333;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.8rem;
        }

        .search-box {
          flex-direction: column;
        }

        .aqi-value {
          font-size: 3rem;
        }

        .metrics-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üåç Air Pollution Prediction System</h1>
        <p>Get real-time AQI data and predictions for any city</p>
      </div>

      <div class="search-section">
        <div class="search-box">
          <input
            type="text"
            class="search-input"
            id="cityInput"
            placeholder="Enter city name (e.g., Delhi, London, New York)"
            onkeypress="if(event.key === 'Enter') searchCity()"
          />
          <button class="search-btn" onclick="searchCity()" id="searchBtn">
            Get AQI Data
          </button>
        </div>
      </div>

      <div class="content" id="content">
        <div class="loading" id="loading" style="display: none">Loading...</div>
        <div id="error" style="display: none"></div>
        <div id="results" style="display: none"></div>

        <div class="legend-section">
          <h2>AQI Categories</h2>
          <div class="legend-grid">
            <div class="legend-item">
              <div
                class="legend-color"
                style="
                  background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
                "
              ></div>
              <div>
                <div class="legend-label">Good</div>
                <div class="legend-range">0 ‚Äì 50</div>
              </div>
            </div>
            <div class="legend-item">
              <div
                class="legend-color"
                style="
                  background: linear-gradient(135deg, #fbc531 0%, #f5b041 100%);
                "
              ></div>
              <div>
                <div class="legend-label">Moderate</div>
                <div class="legend-range">51 ‚Äì 100</div>
              </div>
            </div>
            <div class="legend-item">
              <div
                class="legend-color"
                style="
                  background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
                "
              ></div>
              <div>
                <div class="legend-label">Unhealthy for Sensitive Groups</div>
                <div class="legend-range">101 ‚Äì 150</div>
              </div>
            </div>
            <div class="legend-item">
              <div
                class="legend-color"
                style="
                  background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
                "
              ></div>
              <div>
                <div class="legend-label">Unhealthy</div>
                <div class="legend-range">151 ‚Äì 200</div>
              </div>
            </div>
            <div class="legend-item">
              <div
                class="legend-color"
                style="
                  background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
                "
              ></div>
              <div>
                <div class="legend-label">Very Unhealthy</div>
                <div class="legend-range">201 ‚Äì 300</div>
              </div>
            </div>
            <div class="legend-item">
              <div
                class="legend-color"
                style="
                  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                "
              ></div>
              <div>
                <div class="legend-label">Hazardous</div>
                <div class="legend-range">300+</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Favorites Section - Always Visible -->
      <div class="content" style="padding: 30px">
        <div class="feature-section">
          <h2 style="margin-bottom: 20px; color: #333">‚≠ê Favorite Cities</h2>
          <div id="favoritesContent">
            <div
              id="favoritesList"
              style="
                display: none;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 20px;
              "
            ></div>
            <div
              id="noFavorites"
              style="
                text-align: center;
                padding: 40px;
                color: #666;
                background: #f8f9fa;
                border-radius: 15px;
                display: block;
              "
            >
              <div style="font-size: 3rem; margin-bottom: 20px">‚≠ê</div>
              <p
                style="
                  font-size: 1.2rem;
                  margin-bottom: 15px;
                  font-weight: 600;
                  color: #333;
                "
              >
                No favorite cities yet
              </p>
              <p style="font-size: 0.95rem; color: #666; line-height: 1.6">
                Search for cities above and click the ‚≠ê icon to add them to
                favorites
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Compare Cities Section - Always Visible -->
      <div class="content" style="padding: 30px">
        <div class="feature-section">
          <h2 style="margin-bottom: 20px; color: #333">üìä Compare Cities</h2>
          <div class="search-box" style="max-width: 800px; margin-bottom: 20px">
            <input
              type="text"
              class="search-input"
              id="compareCityInput"
              placeholder="Enter city names separated by commas (e.g., Delhi, Mumbai, Bangalore)"
            />
            <button
              class="search-btn"
              onclick="compareCities()"
              id="compareBtn"
            >
              Compare Cities
            </button>
          </div>
          <div class="loading" id="compareLoading" style="display: none">
            Loading comparison...
          </div>
          <div id="compareError" style="display: none"></div>
          <div id="compareResults" style="display: none"></div>
        </div>
      </div>

      <!-- Analytics Section - Always Visible -->
      <div class="content" style="padding: 30px">
        <div class="feature-section">
          <h2 style="margin-bottom: 20px; color: #333">üìâ Model Analytics</h2>
          <div class="search-box" style="max-width: 600px; margin-bottom: 20px">
            <input
              type="text"
              class="search-input"
              id="analyticsCityInput"
              placeholder="Enter city name for analytics"
            />
            <button
              class="search-btn"
              onclick="loadAnalytics()"
              id="analyticsBtn"
            >
              View Analytics
            </button>
          </div>
          <div class="loading" id="analyticsLoading" style="display: none">
            Loading analytics...
          </div>
          <div id="analyticsError" style="display: none"></div>
          <div id="analyticsResults" style="display: none"></div>
        </div>
      </div>
    </div>

    <script>
      // Dynamic API URL detection
      const API_BASE_URL = (() => {
        // If opened via file:// protocol, default to localhost
        if (window.location.protocol === "file:") {
          return "http://localhost:8000";
        }
        // Local development
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          return "http://localhost:8000";
        }
        // For production, try to detect backend URL
        const backendUrl =
          window.ENV?.API_BASE_URL ||
          window.location.origin.replace(/\/$/, "") ||
          "https://your-backend-service.onrender.com";
        return backendUrl;
      })();

      console.log("API Base URL:", API_BASE_URL);
      let chartInstance = null;
      let forecastChartInstance = null;

      async function searchCity() {
        const cityInput = document.getElementById("cityInput");
        const searchBtn = document.getElementById("searchBtn");
        const loading = document.getElementById("loading");
        const error = document.getElementById("error");
        const results = document.getElementById("results");

        const city = cityInput.value.trim();

        if (!city) {
          showError("Please enter a city name");
          return;
        }

        // Show loading
        loading.style.display = "block";
        error.style.display = "none";
        results.style.display = "none";
        searchBtn.disabled = true;

        try {
          // Fetch main data in parallel
          const [currentData, historyData, predictionData] = await Promise.all([
            fetch(
              `${API_BASE_URL}/current?city=${encodeURIComponent(city)}`
            ).then((r) => r.json()),
            fetch(
              `${API_BASE_URL}/history?city=${encodeURIComponent(city)}`
            ).then((r) => r.json()),
            fetch(
              `${API_BASE_URL}/predict?city=${encodeURIComponent(city)}`
            ).then((r) => r.json()),
          ]);

          // Check for core API errors
          if (
            currentData.detail ||
            historyData.detail ||
            predictionData.detail
          ) {
            const errorMsg =
              currentData.detail || historyData.detail || predictionData.detail;
            // Enhanced error message with suggestions
            let enhancedError = errorMsg;
            if (
              errorMsg.includes("Could not fetch") ||
              errorMsg.includes("not found")
            ) {
              enhancedError +=
                '<br><br><strong>üí° Suggestions:</strong><ul style="margin-top: 10px; padding-left: 20px;"><li>Try using the full city name (e.g., "New York" instead of "NYC")</li><li>Check spelling and try alternative names</li><li>Some smaller cities may not have data available</li><li>Try nearby major cities</li></ul>';
            }
            showError(enhancedError);
            return;
          }

          // Fetch optional advanced data: forecast and alerts (do not block main UI)
          let forecastData = null;
          let alertsData = null;
          try {
            const [forecastRes, alertsRes] = await Promise.all([
              fetch(
                `${API_BASE_URL}/forecast?city=${encodeURIComponent(
                  city
                )}&days=5`
              ).then((r) => r.json()),
              fetch(
                `${API_BASE_URL}/alerts?city=${encodeURIComponent(city)}`
              ).then((r) => r.json()),
            ]);
            forecastData = !forecastRes.detail ? forecastRes : null;
            alertsData = !alertsRes.detail ? alertsRes : null;
          } catch (advErr) {
            console.warn("Advanced data fetch failed:", advErr);
          }

          // Display results (forecast/alerts may be null)
          displayResults(
            currentData,
            historyData,
            predictionData,
            forecastData,
            alertsData
          );
        } catch (err) {
          console.error("Error:", err);
          showError(
            `Failed to fetch data: ${err.message}. Make sure the backend server is running on ${API_BASE_URL}`
          );
        } finally {
          loading.style.display = "none";
          searchBtn.disabled = false;
        }
      }

      function showError(message) {
        const error = document.getElementById("error");
        error.style.display = "block";
        error.className = "error";
        error.innerHTML = message; // Use innerHTML to support HTML suggestions
      }

      function getAQIClass(aqi) {
        if (aqi <= 50) return "aqi-good";
        if (aqi <= 100) return "aqi-moderate";
        if (aqi <= 150) return "aqi-unhealthy";
        if (aqi <= 200) return "aqi-very-unhealthy";
        return "aqi-hazardous";
      }

      function formatNumber(value, decimals = 1, fallback = "N/A") {
        if (value === null || value === undefined) return fallback;
        const num = Number(value);
        if (Number.isNaN(num)) return fallback;
        return num.toFixed(decimals);
      }

      function formatInt(value, fallback = "N/A") {
        if (value === null || value === undefined) return fallback;
        const num = Number(value);
        if (Number.isNaN(num)) return fallback;
        return Math.round(num);
      }

      function displayResults(current, history, prediction, forecast, alerts) {
        const results = document.getElementById("results");
        results.style.display = "block";

        // Current AQI Section
        const aqiClass = getAQIClass(current.aqi);
        const displayPm25 = formatInt(current.pm25);
        const displayPm10 = formatInt(current.pm10);
        const displayO3 = formatNumber(current.o3, 1);
        const displayNo2 = formatNumber(current.no2, 1);
        const displayCo = formatNumber(current.co, 1);
        const displayTemp =
          current.temperature != null
            ? `${formatNumber(current.temperature, 1)}¬∞C`
            : "";
        const displayHumidity =
          current.humidity != null
            ? `${formatNumber(current.humidity, 0)}%`
            : "";
        const displayWind =
          current.wind != null ? `${formatNumber(current.wind, 1)} m/s` : "";
        // Check if city is in favorites
        const favorites = JSON.parse(
          localStorage.getItem("favoriteCities") || "[]"
        );
        const isFavorite = favorites.includes(current.city);
        const favoriteBtn = isFavorite
          ? `<button onclick="removeFavorite('${current.city}'); location.reload();" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; margin-left: 10px;">‚≠ê Remove Favorite</button>`
          : `<button onclick="addFavorite('${current.city}'); location.reload();" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; margin-left: 10px;">‚≠ê Add to Favorites</button>`;

        const currentHTML = `
                <div class="current-aqi ${aqiClass}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <h2>üìç ${current.city}</h2>
                      ${favoriteBtn}
                    </div>
                    <div class="aqi-value">${current.aqi}</div>
                    <div class="health-message">${
                      current.health_message || getHealthMessage(current.aqi)
                    }</div>
                    
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">PM2.5</div>
                            <div class="metric-value">${displayPm25}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">PM10</div>
                            <div class="metric-value">${displayPm10}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">O‚ÇÉ</div>
                            <div class="metric-value">${displayO3}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">NO‚ÇÇ</div>
                            <div class="metric-value">${displayNo2}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">CO</div>
                            <div class="metric-value">${displayCo}</div>
                        </div>
                        ${
                          current.temperature
                            ? `
                        <div class="metric-card">
                            <div class="metric-label">Temperature</div>
                            <div class="metric-value">${displayTemp}</div>
                        </div>
                        `
                            : ""
                        }
                        ${
                          current.humidity
                            ? `
                        <div class="metric-card">
                            <div class="metric-label">Humidity</div>
                            <div class="metric-value">${displayHumidity}</div>
                        </div>
                        `
                            : ""
                        }
                        ${
                          current.wind
                            ? `
                        <div class="metric-card">
                            <div class="metric-label">Wind</div>
                            <div class="metric-value">${displayWind}</div>
                        </div>
                        `
                            : ""
                        }
                    </div>
                    ${
                      current.time
                        ? `<div style="margin-top: 20px; opacity: 0.9;">Last updated: ${new Date(
                            current.time
                          ).toLocaleString()}</div>`
                        : ""
                    }
                </div>
            `;

        // History Chart Section
        const historyHTML = `
                <div class="chart-section">
                    <h2>üìä Last 7 Days AQI History</h2>
                    <div class="chart-container">
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>
            `;

        // Prediction Section with confidence and metrics
        const predAqiClass = getAQIClass(prediction.predicted_aqi);
        const confidenceScore = prediction.confidence_score
          ? (prediction.confidence_score * 100).toFixed(1)
          : "N/A";
        const metrics = prediction.model_metrics || {};
        const r2Score = metrics.r2_score
          ? (metrics.r2_score * 100).toFixed(1)
          : "N/A";
        const mae = metrics.mae ? metrics.mae.toFixed(2) : "N/A";

        const modelName =
          (prediction.model_metrics && prediction.model_metrics.model_name) ||
          "";

        const predictionHTML = `
                <div class="prediction-section ${predAqiClass}">
                    <h2>üîÆ Predicted AQI for Tomorrow</h2>
                    <div class="prediction-value">${Math.round(
                      prediction.predicted_aqi
                    )}</div>
                    <div class="risk-badge">${
                      prediction.risk || prediction.health_message
                    }</div>
                    ${
                      prediction.confidence_score
                        ? `
                    <div style="margin-top: 20px; display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Confidence</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${confidenceScore}%</div>
                        </div>
                        ${
                          metrics.r2_score
                            ? `
                        <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">R¬≤ Score</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${r2Score}%</div>
                        </div>
                        `
                            : ""
                        }
                        ${
                          metrics.mae
                            ? `
                        <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">MAE</div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${mae}</div>
                        </div>
                        `
                            : ""
                        }
                        ${
                          modelName
                            ? `
                        <div style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 10px;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Model</div>
                            <div style="font-size: 1.1rem; font-weight: 600; text-transform: capitalize;">${modelName.replace(
                              "_",
                              " "
                            )}</div>
                        </div>
                        `
                            : ""
                        }
                    </div>
                    `
                        : ""
                    }
                </div>
            `;
        let forecastHTML = "";
        if (
          forecast &&
          Array.isArray(forecast.forecast) &&
          forecast.forecast.length
        ) {
          forecastHTML = `
                <div class="chart-section">
                    <h2>üìà AQI Forecast (Next ${forecast.forecast.length} days)</h2>
                    <div class="chart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            `;
        }

        let alertsHTML = "";
        if (alerts && Array.isArray(alerts.alerts)) {
          const items = alerts.alerts
            .map(
              (a) => `
                <div class="alert-card ${a.level}">
                    <div class="alert-type">${a.type.toUpperCase()} ‚Ä¢ ${a.level.toUpperCase()}</div>
                    <div class="alert-message">${a.message}</div>
                </div>
            `
            )
            .join("");

          alertsHTML = `
                <div class="alerts-section">
                    <h2>‚ö†Ô∏è Air Quality Alerts</h2>
                    <div class="alerts-list">
                        ${
                          items ||
                          '<div style="opacity:0.8;font-size:0.95rem;">No alerts for this city right now.</div>'
                        }
                    </div>
                </div>
            `;
        }

        results.innerHTML =
          currentHTML +
          historyHTML +
          predictionHTML +
          forecastHTML +
          alertsHTML;

        // Refresh favorites display (already visible)
        loadFavorites();

        // Draw charts
        drawChart(history.history || []);
        if (
          forecast &&
          Array.isArray(forecast.forecast) &&
          forecast.forecast.length
        ) {
          drawForecastChart(forecast.forecast);
        }
      }

      function drawChart(historyData) {
        const ctx = document.getElementById("historyChart").getContext("2d");

        // Destroy existing chart if it exists
        if (chartInstance) {
          chartInstance.destroy();
        }

        const labels = historyData.map((item) => {
          const date = new Date(item.day);
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        });

        const aqiValues = historyData.map((item) => item.aqi);

        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "AQI",
                data: aqiValues,
                borderColor: "#667eea",
                backgroundColor: "rgba(102, 126, 234, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: "#667eea",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "AQI Value",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Date",
                },
              },
            },
          },
        });
      }

      function drawForecastChart(forecastData) {
        const canvas = document.getElementById("forecastChart");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");

        if (forecastChartInstance) {
          forecastChartInstance.destroy();
        }

        const labels = forecastData.map((item) => {
          const date = new Date(item.day);
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        });

        const values = forecastData.map((item) => item.predicted_aqi);

        forecastChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Predicted AQI",
                data: values,
                borderColor: "#4facfe",
                backgroundColor: "rgba(79, 172, 254, 0.12)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: "#4facfe",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "AQI Value",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Date",
                },
              },
            },
          },
        });
      }

      function getHealthMessage(aqi) {
        if (aqi <= 50) return "Good";
        if (aqi <= 100) return "Moderate";
        if (aqi <= 150) return "Unhealthy for Sensitive Groups";
        if (aqi <= 200) return "Unhealthy";
        if (aqi <= 300) return "Very Unhealthy";
        return "Hazardous";
      }

      // Test backend connection
      async function testBackendConnection() {
        try {
          const response = await fetch(`${API_BASE_URL}/health`);
          if (response.ok) {
            const data = await response.json();
            console.log("‚úÖ Backend is running:", data);
            return true;
          } else {
            console.error("‚ùå Backend health check failed:", response.status);
            return false;
          }
        } catch (err) {
          console.error("‚ùå Backend connection failed:", err);
          return false;
        }
      }

      // Initialize on load
      document.addEventListener("DOMContentLoaded", () => {
        console.log("üöÄ App initialized. API Base URL:", API_BASE_URL);

        // Make functions globally available
        window.searchCity = searchCity;
        window.addFavorite = addFavorite;
        window.removeFavorite = removeFavorite;
        window.compareCities = compareCities;
        window.loadAnalytics = loadAnalytics;
        window.loadFavorites = loadFavorites;

        // Load favorites on page load
        loadFavorites();

        testBackendConnection().then((isConnected) => {
          if (!isConnected) {
            console.warn(
              "‚ö†Ô∏è Backend not connected. Some features may not work."
            );
            console.warn(
              "üí° Make sure backend is running: cd backend && uvicorn main:app --reload --host 0.0.0.0 --port 8000"
            );
          }
        });
      });

      // Favorite functions (used in home page)
      function addFavorite(city) {
        const favorites = JSON.parse(
          localStorage.getItem("favoriteCities") || "[]"
        );
        if (!favorites.includes(city)) {
          favorites.push(city);
          localStorage.setItem("favoriteCities", JSON.stringify(favorites));
          console.log("‚≠ê Added to favorites:", city);
          loadFavorites(); // Refresh favorites display
        }
      }

      function removeFavorite(city) {
        const favorites = JSON.parse(
          localStorage.getItem("favoriteCities") || "[]"
        );
        const updated = favorites.filter((c) => c !== city);
        localStorage.setItem("favoriteCities", JSON.stringify(updated));
        console.log("üóëÔ∏è Removed from favorites:", city);
        loadFavorites(); // Refresh favorites display
        // Reload page to update favorite button in current results
        location.reload();
      }

      // Compare Cities function
      async function compareCities() {
        const input = document.getElementById("compareCityInput");
        const btn = document.getElementById("compareBtn");
        const loading = document.getElementById("compareLoading");
        const error = document.getElementById("compareError");
        const results = document.getElementById("compareResults");

        const citiesStr = input.value.trim();
        if (!citiesStr) {
          showCompareError("Please enter at least one city name");
          return;
        }

        const cities = citiesStr
          .split(",")
          .map((c) => c.trim())
          .filter((c) => c);
        if (cities.length === 0) {
          showCompareError("Please enter valid city names");
          return;
        }

        loading.style.display = "block";
        error.style.display = "none";
        results.style.display = "none";
        btn.disabled = true;

        try {
          const response = await fetch(`${API_BASE_URL}/compare`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cities }),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({
              detail: `HTTP ${response.status}: ${response.statusText}`,
            }));
            showCompareError(
              errorData.detail || `Failed to fetch data: ${response.statusText}`
            );
            return;
          }

          const data = await response.json();
          if (data.detail) {
            showCompareError(data.detail);
            return;
          }

          const comparisons = data.comparisons || [];
          if (comparisons.length === 0) {
            showCompareError("No data available for the selected cities");
            return;
          }

          let html =
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">';
          comparisons.forEach((city) => {
            const aqiClass = getAQIClass(city.current_aqi);
            html += `
              <div class="current-aqi ${aqiClass}" style="margin: 0;">
                <h3>üìç ${city.city}</h3>
                <div style="font-size: 2.5rem; font-weight: bold; margin: 15px 0;">${
                  city.current_aqi
                }</div>
                <div style="margin: 10px 0;">Current: ${getHealthMessage(
                  city.current_aqi
                )}</div>
                <div style="margin: 10px 0;">Predicted: ${city.predicted_aqi.toFixed(
                  1
                )} (${city.health_message})</div>
              </div>
            `;
          });
          html += "</div>";

          results.innerHTML = html;
          results.style.display = "block";
        } catch (err) {
          console.error("Compare cities error:", err);
          showCompareError(`Failed to compare cities: ${err.message}`);
        } finally {
          loading.style.display = "none";
          btn.disabled = false;
        }
      }

      function showCompareError(message) {
        const error = document.getElementById("compareError");
        error.style.display = "block";
        error.className = "error";
        error.innerHTML = message;
      }

      // Load Favorites function
      async function loadFavorites() {
        const favorites = JSON.parse(
          localStorage.getItem("favoriteCities") || "[]"
        );
        const list = document.getElementById("favoritesList");
        const noFavorites = document.getElementById("noFavorites");

        if (favorites.length === 0) {
          list.style.display = "none";
          noFavorites.style.display = "block";
          return;
        }

        list.style.display = "grid";
        noFavorites.style.display = "none";
        list.innerHTML =
          '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">Loading favorite cities...</div>';

        // Fetch data for all favorites in parallel
        const cityPromises = favorites.map(async (city) => {
          try {
            const response = await fetch(
              `${API_BASE_URL}/current?city=${encodeURIComponent(city)}`
            );
            if (!response.ok) {
              return { city, error: true, data: null };
            }
            const data = await response.json();
            if (data.detail) {
              return { city, error: true, data: null };
            }
            return { city, error: false, data };
          } catch (err) {
            console.error(`Error fetching ${city}:`, err);
            return { city, error: true, data: null };
          }
        });

        const results = await Promise.all(cityPromises);
        list.innerHTML = "";

        results.forEach(({ city, error, data }) => {
          const card = document.createElement("div");
          card.style.cursor = "pointer";
          card.style.position = "relative";

          if (error || !data) {
            card.className = "current-aqi aqi-moderate";
            const viewBtn = document.createElement("button");
            viewBtn.textContent = "View Details";
            viewBtn.style.cssText =
              "background: rgba(255,255,255,0.3); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; flex: 1;";
            viewBtn.onclick = (e) => {
              e.stopPropagation();
              document.getElementById("cityInput").value = city;
              searchCity();
              // Scroll to top to see results
              window.scrollTo({ top: 0, behavior: "smooth" });
            };

            const removeBtn = document.createElement("button");
            removeBtn.textContent = "Remove";
            removeBtn.style.cssText =
              "background: rgba(255,255,255,0.3); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer;";
            removeBtn.onclick = (e) => {
              e.stopPropagation();
              removeFavorite(city);
            };

            const btnContainer = document.createElement("div");
            btnContainer.style.cssText =
              "display: flex; gap: 10px; margin-top: 15px;";
            btnContainer.appendChild(viewBtn);
            btnContainer.appendChild(removeBtn);

            card.innerHTML = `
              <h3>üìç ${city}</h3>
              <div style="margin: 15px 0; opacity: 0.8;">Unable to load data</div>
            `;
            card.appendChild(btnContainer);
          } else {
            const aqiClass = getAQIClass(data.aqi);
            card.className = `current-aqi ${aqiClass}`;

            const viewBtn = document.createElement("button");
            viewBtn.textContent = "View Details";
            viewBtn.style.cssText =
              "background: rgba(255,255,255,0.3); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; flex: 1;";
            viewBtn.onclick = (e) => {
              e.stopPropagation();
              document.getElementById("cityInput").value = data.city;
              searchCity();
              // Scroll to top to see results
              window.scrollTo({ top: 0, behavior: "smooth" });
            };

            const removeBtn = document.createElement("button");
            removeBtn.textContent = "Remove";
            removeBtn.style.cssText =
              "background: rgba(255,255,255,0.3); border: none; color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer;";
            removeBtn.onclick = (e) => {
              e.stopPropagation();
              removeFavorite(data.city);
            };

            const btnContainer = document.createElement("div");
            btnContainer.style.cssText =
              "display: flex; gap: 10px; margin-top: 15px;";
            btnContainer.appendChild(viewBtn);
            btnContainer.appendChild(removeBtn);

            card.onclick = () => {
              document.getElementById("cityInput").value = data.city;
              searchCity();
              window.scrollTo({ top: 0, behavior: "smooth" });
            };
            card.innerHTML = `
              <h3>üìç ${data.city}</h3>
              <div style="font-size: 2.5rem; font-weight: bold; margin: 15px 0;">${
                data.aqi
              }</div>
              <div style="margin: 10px 0;">${
                data.health_message || getHealthMessage(data.aqi)
              }</div>
            `;
            card.appendChild(btnContainer);
          }
          list.appendChild(card);
        });
      }

      // Analytics function
      async function loadAnalytics() {
        const input = document.getElementById("analyticsCityInput");
        const btn = document.getElementById("analyticsBtn");
        const loading = document.getElementById("analyticsLoading");
        const error = document.getElementById("analyticsError");
        const results = document.getElementById("analyticsResults");

        const city = input.value.trim();
        if (!city) {
          showAnalyticsError("Please enter a city name");
          return;
        }

        loading.style.display = "block";
        error.style.display = "none";
        results.style.display = "none";
        btn.disabled = true;

        try {
          const response = await fetch(
            `${API_BASE_URL}/model/backtest?city=${encodeURIComponent(city)}`
          );

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({
              detail: `HTTP ${response.status}: ${response.statusText}`,
            }));
            showAnalyticsError(
              errorData.detail ||
                `Failed to fetch analytics: ${response.statusText}`
            );
            return;
          }

          const data = await response.json();
          if (data.detail) {
            showAnalyticsError(data.detail);
            return;
          }

          const metrics = data.metrics || {};
          let html = `
            <div class="chart-section">
              <h2>üìâ Model Performance for ${data.city}</h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; text-align: center;">
                  <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">R¬≤ Score</div>
                  <div style="font-size: 2.5rem; font-weight: bold; color: #667eea;">${(
                    metrics.r2_score * 100
                  ).toFixed(1)}%</div>
                </div>
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; text-align: center;">
                  <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Mean Absolute Error</div>
                  <div style="font-size: 2.5rem; font-weight: bold; color: #667eea;">${metrics.mae.toFixed(
                    2
                  )}</div>
                </div>
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; text-align: center;">
                  <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">RMSE</div>
                  <div style="font-size: 2.5rem; font-weight: bold; color: #667eea;">${metrics.rmse.toFixed(
                    2
                  )}</div>
                </div>
                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; text-align: center;">
                  <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Samples</div>
                  <div style="font-size: 2.5rem; font-weight: bold; color: #667eea;">${
                    metrics.samples
                  }</div>
                </div>
              </div>
              <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                <h3 style="margin-bottom: 15px;">Trend Analysis</h3>
                <p><strong>Trend:</strong> ${data.trend}</p>
                <p><strong>Change:</strong> ${data.trend_change_percent.toFixed(
                  2
                )}%</p>
                <p><strong>Volatility:</strong> ${data.volatility.toFixed(
                  2
                )}</p>
              </div>
            </div>
          `;

          results.innerHTML = html;
          results.style.display = "block";
        } catch (err) {
          console.error("Analytics error:", err);
          showAnalyticsError(`Failed to load analytics: ${err.message}`);
        } finally {
          loading.style.display = "none";
          btn.disabled = false;
        }
      }

      function showAnalyticsError(message) {
        const error = document.getElementById("analyticsError");
        error.style.display = "block";
        error.className = "error";
        error.innerHTML = message;
      }
    </script>
  </body>
</html>
